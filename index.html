<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TrackIT - Expense Tracker (Firebase)</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', sans-serif; background: #f5f5f5; color: #333; overflow-x: hidden; }
    
    .header { background: white; padding: 16px 0; box-shadow: 0 2px 8px rgba(0,0,0,0.08); position: fixed; top: 0; left: 0; right: 0; z-index: 100; }
    .header-content { display: flex; justify-content: space-between; align-items: center; padding: 0 20px; max-width: 1200px; margin: 0 auto; width: 100%; }
    .header-left { display: flex; align-items: center; gap: 16px; }
    .logo { font-size: 20px; font-weight: 700; color: #2563eb; }
    
    /* Desktop: Show header-right */
    .header-right { display: flex; align-items: center; gap: 16px; }
    
    /* Mobile: Hide header-right by default */
    @media (max-width: 768px) {
      .header-right { display: none !important; }
    }
    
    .user-info { display: flex; align-items: center; gap: 12px; }
    .user-avatar { width: 36px; height: 36px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; display: flex; align-items: center; justify-content: center; font-weight: 600; }
    .btn-logout { padding: 8px 16px; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: background 0.3s; }
    .btn-logout:hover { background: #dc2626; }
    
    .sidebar { position: fixed; left: 0; top: 60px; width: 250px; height: calc(100vh - 60px); background: white; border-right: 1px solid #e5e7eb; overflow-y: auto; display: flex; flex-direction: column; z-index: 99; }
    .sidebar-content { flex: 1; padding: 20px 0; }
    .sidebar-bottom { padding: 16px 20px; border-top: 1px solid #e5e7eb; display: none; }
    
    /* Mobile: Show sidebar-bottom */
    @media (max-width: 768px) {
      .sidebar-bottom { display: block; }
    }
    
    .nav-item { padding: 12px 20px; cursor: pointer; color: #666; transition: all 0.3s; display: flex; align-items: center; gap: 10px; margin: 0 8px; border-radius: 6px; }
    .nav-item:hover { background: #f0f0f0; color: #2563eb; }
    .nav-item.active { background: #dbeafe; color: #2563eb; font-weight: 600; }
    .nav-icon { font-size: 18px; }
    
    .main { margin-left: 250px; margin-top: 60px; padding: 20px; }
    @media (max-width: 768px) { .main { margin-left: 0; } }
    
    .container { max-width: 1200px; margin: 0 auto; }
    
    /* Dashboard cards and charts */
    .summary-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .card { background: white; padding: 24px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
    .card-title { font-size: 14px; color: #666; margin-bottom: 8px; font-weight: 500; }
    .card-value { font-size: 28px; font-weight: 700; color: #2563eb; }
    .card.income .card-value { color: #10b981; }
    .card.expense .card-value { color: #ef4444; }
    
    .chart-container { background: white; padding: 24px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 20px; }
    .chart-title { font-size: 18px; font-weight: 600; margin-bottom: 20px; }
    
    .transactions-list { background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); padding: 20px; }
    .transaction-item { display: flex; justify-content: space-between; align-items: center; padding: 16px 0; border-bottom: 1px solid #e5e7eb; }
    .transaction-item:last-child { border-bottom: none; }
    .transaction-left { display: flex; align-items: center; gap: 12px; }
    .transaction-category { width: 40px; height: 40px; border-radius: 8px; background: #f0f0f0; display: flex; align-items: center; justify-content: center; font-size: 18px; }
    .transaction-details h4 { font-size: 14px; font-weight: 600; color: #333; }
    .transaction-details p { font-size: 12px; color: #999; margin-top: 4px; }
    .transaction-amount { font-size: 16px; font-weight: 700; color: #10b981; }
    .transaction-amount.expense { color: #ef4444; }
    
    .page { display: none; }
    .page.active { display: block; }
    
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 200; align-items: center; justify-content: center; }
    .modal.open { display: flex; }
    .modal-content { background: white; padding: 30px; border-radius: 12px; width: 90%; max-width: 500px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
    .modal-header { font-size: 20px; font-weight: 700; margin-bottom: 20px; }
    .form-group { margin-bottom: 16px; }
    .form-group label { display: block; font-size: 14px; font-weight: 500; margin-bottom: 6px; color: #333; }
    .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-family: inherit; }
    .form-group textarea { resize: vertical; min-height: 80px; }
    .form-actions { display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px; }
    .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s; }
    .btn-primary { background: #2563eb; color: white; }
    .btn-primary:hover { background: #1d4ed8; }
    .btn-secondary { background: #e5e7eb; color: #333; }
    .btn-secondary:hover { background: #d1d5db; }
    .btn-danger { background: #ef4444; color: white; }
    .btn-danger:hover { background: #dc2626; }
    
    .notification { position: fixed; bottom: 20px; right: 20px; background: #10b981; color: white; padding: 16px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 300; animation: slideIn 0.3s ease; }
    @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    
    .auth-page { display: flex; align-items: center; justify-content: center; min-height: 100vh; }
    .auth-form { background: white; padding: 40px; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); width: 100%; max-width: 400px; }
    .auth-title { font-size: 24px; font-weight: 700; margin-bottom: 24px; text-align: center; color: #333; }
    
    .budget-item { display: flex; justify-content: space-between; align-items: center; padding: 16px 0; border-bottom: 1px solid #e5e7eb; }
    .budget-item:last-child { border-bottom: none; }
    .budget-name { font-weight: 500; color: #333; }
    .budget-bar { flex: 1; margin: 0 16px; height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden; }
    .budget-progress { height: 100%; background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); }
    .budget-progress.warning { background: linear-gradient(90deg, #f59e0b 0%, #f97316 100%); }
    .budget-progress.danger { background: linear-gradient(90deg, #ef4444 0%, #dc2626 100%); }
    .budget-amount { font-size: 12px; color: #666; min-width: 80px; text-align: right; }
    
    .settings-section { margin-bottom: 30px; }
    .settings-section-title { font-size: 18px; font-weight: 600; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 2px solid #e5e7eb; }
    .settings-option { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; }
    .settings-option label { font-weight: 500; color: #333; }
    .settings-option select { padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; }
    
    /* Mobile sidebar width adjustment */
    @media (max-width: 768px) {
      .sidebar { width: 100%; top: 60px; height: calc(100vh - 60px); border-right: none; border-bottom: 1px solid #e5e7eb; }
      .sidebar-content { flex: 1; display: flex; flex-direction: row; overflow-x: auto; }
      .nav-item { flex-shrink: 0; }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <div class="header-content">
      <div class="header-left">
        <div class="logo">TrackIT</div>
      </div>
      <div class="header-right" id="headerRight">
        <div class="user-info">
          <div class="user-avatar" id="userAvatar">U</div>
          <span id="userName">User</span>
        </div>
        <button class="btn-logout" id="logoutBtn">Logout</button>
      </div>
    </div>
  </div>

  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-content">
      <div class="nav-item active" data-page="home">üìä Dashboard</div>
      <div class="nav-item" data-page="history">üìú History</div>
      <div class="nav-item" data-page="analytics">üìà Analytics</div>
      <div class="nav-item" data-page="recurring">üîÑ Recurring</div>
      <div class="nav-item" data-page="budget">üí∞ Budget</div>
      <div class="nav-item" data-page="settings">‚öôÔ∏è Settings</div>
    </div>
    <!-- User info moved to bottom on mobile -->
    <div class="sidebar-bottom" id="sidebarBottom">
      <div class="user-info" style="margin-bottom: 12px;">
        <div class="user-avatar" id="userAvatarMobile">U</div>
        <span id="userNameMobile">User</span>
      </div>
      <button class="btn-logout" id="logoutBtnMobile" style="width: 100%;">Logout</button>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main">
    <div class="container">
      
      <!-- HOME PAGE -->
      <div class="page active" id="home">
        <h2 style="margin-bottom: 20px;">Dashboard</h2>
        <div class="summary-cards">
          <div class="card">
            <div class="card-title">Total Balance</div>
            <div class="card-value" id="totalBalance">‚Çπ0</div>
          </div>
          <div class="card income">
            <div class="card-title">Total Income</div>
            <div class="card-value" id="totalIncome">‚Çπ0</div>
          </div>
          <div class="card expense">
            <div class="card-title">Total Expenses</div>
            <div class="card-value" id="totalExpense">‚Çπ0</div>
          </div>
          <div class="card">
            <div class="card-title">This Month</div>
            <div class="card-value" id="monthlyExpense">‚Çπ0</div>
          </div>
        </div>

        <div class="chart-container">
          <div class="chart-title">Spending by Category</div>
          <canvas id="spendingChart"></canvas>
        </div>

        <h3 style="margin: 30px 0 20px 0;">Recent Transactions</h3>
        <div class="transactions-list" id="recentTransactions">
          <p style="color: #999;">No transactions yet. Add your first one!</p>
        </div>

        <div style="text-align: center; margin-top: 20px;">
          <button class="btn btn-primary" id="addTransactionBtn">+ Add Transaction</button>
        </div>
      </div>

      <!-- HISTORY PAGE -->
      <div class="page" id="history">
        <h2 style="margin-bottom: 20px;">Transaction History</h2>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 20px;">
          <select id="filterType">
            <option value="">All Transactions</option>
            <option value="income">Income</option>
            <option value="expense">Expense</option>
          </select>
          <select id="filterDate">
            <option value="all">All Time</option>
            <option value="today">Today</option>
            <option value="week">This Week</option>
            <option value="month">This Month</option>
          </select>
          <input type="text" id="searchTransactions" placeholder="Search by title..." style="padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 6px;">
        </div>
        <div class="transactions-list" id="transactionsList">
          <p style="color: #999;">No transactions found.</p>
        </div>
      </div>

      <!-- ANALYTICS PAGE -->
      <div class="page" id="analytics">
        <h2 style="margin-bottom: 20px;">Analytics</h2>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
          <div class="card">
            <div class="card-title">Total Transactions</div>
            <div class="card-value" id="totalTransactions">0</div>
          </div>
          <div class="card">
            <div class="card-title">Daily Average</div>
            <div class="card-value" id="dailyAverage">‚Çπ0</div>
          </div>
          <div class="card">
            <div class="card-title">Current Month</div>
            <div class="card-value" id="currentMonth">‚Çπ0</div>
          </div>
          <div class="card">
            <div class="card-title">Last 7 Days</div>
            <div class="card-value" id="last7Days">‚Çπ0</div>
          </div>
        </div>

        <div class="chart-container">
          <div class="chart-title">Spending Trend (12 Months)</div>
          <canvas id="trendChart"></canvas>
        </div>

        <div class="chart-container">
          <div class="chart-title">Expense Distribution</div>
          <canvas id="distributionChart"></canvas>
        </div>
      </div>

      <!-- RECURRING PAGE -->
      <div class="page" id="recurring">
        <h2 style="margin-bottom: 20px;">Recurring Payments</h2>
        <div style="margin-bottom: 20px;">
          <button class="btn btn-primary" id="addRecurringBtn">+ Add Recurring Payment</button>
        </div>
        <div class="transactions-list" id="recurringList">
          <p style="color: #999;">No recurring payments set.</p>
        </div>
      </div>

      <!-- BUDGET PAGE -->
      <div class="page" id="budget">
        <h2 style="margin-bottom: 20px;">Budget Management</h2>
        <div class="card" style="margin-bottom: 20px;">
          <div class="card-title">Overall Monthly Budget</div>
          <div style="display: flex; gap: 10px; align-items: center;">
            <input type="number" id="overallBudget" placeholder="Set budget" style="padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 6px; flex: 1;">
            <button class="btn btn-primary" id="saveBudgetBtn">Save</button>
          </div>
        </div>

        <h3 style="margin: 30px 0 20px 0;">Category Budgets</h3>
        <div class="transactions-list" id="budgetList">
          <p style="color: #999;">Loading categories...</p>
        </div>
      </div>

      <!-- SETTINGS PAGE -->
      <div class="page" id="settings">
        <h2 style="margin-bottom: 20px;">Settings</h2>
        
        <div class="settings-section">
          <div class="settings-section-title">Preferences</div>
          <div class="settings-option">
            <label>Currency</label>
            <select id="currencySelect">
              <option value="‚Çπ">‚Çπ Indian Rupee</option>
              <option value="$">$ US Dollar</option>
              <option value="‚Ç¨">‚Ç¨ Euro</option>
              <option value="¬£">¬£ British Pound</option>
            </select>
          </div>
        </div>

        <div class="settings-section">
          <div class="settings-section-title">Data Management</div>
          <button class="btn btn-primary" id="exportCSVBtn">üì• Export as CSV</button>
          <button class="btn btn-primary" style="margin-left: 10px;">üì§ Import Data</button>
          <button class="btn btn-danger" id="deleteAllBtn" style="margin-left: 10px;">üóëÔ∏è Delete All Data</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Add/Edit Transaction Modal -->
  <div class="modal" id="transactionModal">
    <div class="modal-content">
      <div class="modal-header">Add Transaction</div>
      <form id="transactionForm">
        <div class="form-group">
          <label>Type</label>
          <select id="transactionType" required>
            <option value="expense">Expense</option>
            <option value="income">Income</option>
          </select>
        </div>
        <div class="form-group">
          <label>Category</label>
          <select id="transactionCategory" required>
            <option value="Food">üçî Food</option>
            <option value="Travel">‚úàÔ∏è Travel</option>
            <option value="Rent">üè† Rent</option>
            <option value="Shopping">üõçÔ∏è Shopping</option>
            <option value="Salary">üíº Salary</option>
            <option value="Entertainment">üé¨ Entertainment</option>
            <option value="Bills">üìÑ Bills</option>
            <option value="Health">üè• Health</option>
            <option value="Other">üìå Other</option>
          </select>
        </div>
        <div class="form-group">
          <label>Title</label>
          <input type="text" id="transactionTitle" placeholder="Enter title" required>
        </div>
        <div class="form-group">
          <label>Amount</label>
          <input type="number" id="transactionAmount" placeholder="Enter amount" step="0.01" required>
        </div>
        <div class="form-group">
          <label>Date</label>
          <input type="date" id="transactionDate" required>
        </div>
        <div class="form-group">
          <label>Notes</label>
          <textarea id="transactionNotes" placeholder="Add notes..."></textarea>
        </div>
        <div class="form-actions">
          <button type="button" class="btn btn-secondary" onclick="closeModal('transactionModal')">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Transaction</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Add Recurring Modal -->
  <div class="modal" id="recurringModal">
    <div class="modal-content">
      <div class="modal-header">Add Recurring Payment</div>
      <form id="recurringForm">
        <div class="form-group">
          <label>Title</label>
          <input type="text" id="recurringTitle" placeholder="e.g., Gym Membership" required>
        </div>
        <div class="form-group">
          <label>Amount</label>
          <input type="number" id="recurringAmount" placeholder="Enter amount" step="0.01" required>
        </div>
        <div class="form-group">
          <label>Category</label>
          <select id="recurringCategory" required>
            <option value="Food">üçî Food</option>
            <option value="Travel">‚úàÔ∏è Travel</option>
            <option value="Rent">üè† Rent</option>
            <option value="Shopping">üõçÔ∏è Shopping</option>
            <option value="Entertainment">üé¨ Entertainment</option>
            <option value="Bills">üìÑ Bills</option>
            <option value="Health">üè• Health</option>
            <option value="Other">üìå Other</option>
          </select>
        </div>
        <div class="form-group">
          <label>Frequency</label>
          <select id="recurringFrequency" required>
            <option value="weekly">Weekly</option>
            <option value="biweekly">Bi-weekly</option>
            <option value="monthly">Monthly</option>
            <option value="quarterly">Quarterly</option>
            <option value="yearly">Yearly</option>
          </select>
        </div>
        <div class="form-group">
          <label>Due Day</label>
          <input type="number" id="recurringDay" min="1" max="31" placeholder="Day of month" required>
        </div>
        <div class="form-actions">
          <button type="button" class="btn btn-secondary" onclick="closeModal('recurringModal')">Cancel</button>
          <button type="submit" class="btn btn-primary">Save</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Firebase Config and Scripts -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, where, onSnapshot, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyARlJHvz-kVLqBbXmRw2F_qHJDNv5gf_Io",
      authDomain: "trackit-expense-tracker-8e803.firebaseapp.com",
      projectId: "trackit-expense-tracker-8e803",
      storageBucket: "trackit-expense-tracker-8e803.appspot.com",
      messagingSenderId: "759159047532",
      appId: "1:759159047532:web:aeeb5eb4b62a64aa73cfb8"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    let currentUser = null;
    let allTransactions = [];
    let spendingChart, trendChart, distributionChart;

    onAuthStateChanged(auth, (user) => {
      if (user) {
        currentUser = user;
        updateUserInfo(user);
        startRealtimeListeners();
      } else {
        showAuthPage();
      }
    });

    function updateUserInfo(user) {
      const initial = user.email[0].toUpperCase();
      document.getElementById('userAvatar').textContent = initial;
      document.getElementById('userAvatarMobile').textContent = initial;
      document.getElementById('userName').textContent = user.email.split('@')[0];
      document.getElementById('userNameMobile').textContent = user.email.split('@')[0];
    }

    function startRealtimeListeners() {
      const transactionsRef = collection(db, `users/${currentUser.uid}/transactions`);
      onSnapshot(transactionsRef, (snapshot) => {
        allTransactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        updateAnalytics();
      });
    }

    function updateAnalytics() {
      let totalIncome = 0, totalExpense = 0;
      let categorySpending = {};
      let monthlyData = Array(12).fill(0);

      const now = new Date();
      const currentMonth = now.getMonth();
      const currentYear = now.getFullYear();

      allTransactions.forEach(t => {
        const amount = parseFloat(t.amount);
        const date = new Date(t.date);

        if (t.type === 'income') totalIncome += amount;
        else {
          totalExpense += amount;
          categorySpending[t.category] = (categorySpending[t.category] || 0) + amount;
          
          if (date.getMonth() === currentMonth && date.getFullYear() === currentYear) {
            monthlyData[currentMonth] += amount;
          }
        }
      });

      // Calculate year trend
      for (let i = 11; i >= 0; i--) {
        const month = (currentMonth - i + 12) % 12;
        allTransactions.forEach(t => {
          if (t.type === 'expense') {
            const date = new Date(t.date);
            if (date.getMonth() === month) monthlyData[i] = (monthlyData[i] || 0) + parseFloat(t.amount);
          }
        });
      }

      const totalBalance = totalIncome - totalExpense;

      // Update cards
      document.getElementById('totalBalance').textContent = `${getCurrency()}${totalBalance.toFixed(2)}`;
      document.getElementById('totalIncome').textContent = `${getCurrency()}${totalIncome.toFixed(2)}`;
      document.getElementById('totalExpense').textContent = `${getCurrency()}${totalExpense.toFixed(2)}`;
      document.getElementById('monthlyExpense').textContent = `${getCurrency()}${monthlyData[currentMonth].toFixed(2)}`;
      document.getElementById('totalTransactions').textContent = allTransactions.length;
      document.getElementById('dailyAverage').textContent = `${getCurrency()}${(totalExpense / Math.max(1, getDaysSinceFirstTransaction())).toFixed(2)}`;
      document.getElementById('currentMonth').textContent = `${getCurrency()}${monthlyData[currentMonth].toFixed(2)}`;

      // Last 7 days
      let last7Days = 0;
      const sevenDaysAgo = new Date(now);
      sevenDaysAgo.setDate(now.getDate() - 7);
      allTransactions.forEach(t => {
        const date = new Date(t.date);
        if (date >= sevenDaysAgo && t.type === 'expense') last7Days += parseFloat(t.amount);
      });
      document.getElementById('last7Days').textContent = `${getCurrency()}${last7Days.toFixed(2)}`;

      // Update charts
      updateSpendingChart(categorySpending);
      updateTrendChart(monthlyData);
      updateDistributionChart(categorySpending);

      // Update transaction displays
      updateRecentTransactions();
      updateTransactionsList();
    }

    function updateRecentTransactions() {
      const recent = allTransactions.slice(-5).reverse();
      const container = document.getElementById('recentTransactions');
      
      if (recent.length === 0) {
        container.innerHTML = '<p style="color: #999;">No transactions yet.</p>';
        return;
      }

      container.innerHTML = recent.map(t => `
        <div class="transaction-item">
          <div class="transaction-left">
            <div class="transaction-category">${getCategoryEmoji(t.category)}</div>
            <div class="transaction-details">
              <h4>${t.title}</h4>
              <p>${new Date(t.date).toLocaleDateString()}</p>
            </div>
          </div>
          <div class="transaction-amount ${t.type === 'expense' ? 'expense' : ''}">
            ${t.type === 'income' ? '+' : '-'}${getCurrency()}${Math.abs(parseFloat(t.amount)).toFixed(2)}
          </div>
        </div>
      `).join('');
    }

    function updateTransactionsList() {
      const container = document.getElementById('transactionsList');
      const filterType = document.getElementById('filterType').value;
      const filterDate = document.getElementById('filterDate').value;
      const searchTerm = document.getElementById('searchTransactions').value.toLowerCase();

      let filtered = allTransactions.filter(t => {
        if (filterType && t.type !== filterType) return false;
        if (searchTerm && !t.title.toLowerCase().includes(searchTerm)) return false;

        const date = new Date(t.date);
        const now = new Date();
        if (filterDate === 'today' && date.toDateString() !== now.toDateString()) return false;
        if (filterDate === 'week' && (now - date) > 7 * 24 * 60 * 60 * 1000) return false;
        if (filterDate === 'month' && date.getMonth() !== now.getMonth()) return false;

        return true;
      });

      if (filtered.length === 0) {
        container.innerHTML = '<p style="color: #999;">No transactions found.</p>';
        return;
      }

      container.innerHTML = filtered.map(t => `
        <div class="transaction-item">
          <div class="transaction-left">
            <div class="transaction-category">${getCategoryEmoji(t.category)}</div>
            <div class="transaction-details">
              <h4>${t.title}</h4>
              <p>${new Date(t.date).toLocaleDateString()}</p>
            </div>
          </div>
          <div style="display: flex; align-items: center; gap: 12px;">
            <div class="transaction-amount ${t.type === 'expense' ? 'expense' : ''}">
              ${t.type === 'income' ? '+' : '-'}${getCurrency()}${Math.abs(parseFloat(t.amount)).toFixed(2)}
            </div>
            <button onclick="deleteTransaction('${t.id}')" class="btn btn-danger" style="padding: 6px 12px;">Delete</button>
          </div>
        </div>
      `).join('');
    }

    function updateSpendingChart(categorySpending) {
      const ctx = document.getElementById('spendingChart').getContext('2d');
      
      if (spendingChart) spendingChart.destroy();
      
      const labels = Object.keys(categorySpending).slice(0, 5);
      const data = labels.map(cat => categorySpending[cat]);
      const colors = ['#667eea', '#764ba2', '#f093fb', '#4facfe', '#00f2fe'];

      spendingChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: labels,
          datasets: [{
            data: data,
            backgroundColor: colors,
            borderColor: '#fff',
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: { legend: { position: 'bottom' } }
        }
      });
    }

    function updateTrendChart(monthlyData) {
      const ctx = document.getElementById('trendChart').getContext('2d');
      
      if (trendChart) trendChart.destroy();
      
      const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      
      trendChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: monthNames,
          datasets: [{
            label: 'Monthly Expenses',
            data: monthlyData,
            borderColor: '#ef4444',
            backgroundColor: 'rgba(239, 68, 68, 0.1)',
            tension: 0.4,
            fill: true,
            pointBackgroundColor: '#ef4444'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: { legend: { display: true } }
        }
      });
    }

    function updateDistributionChart(categorySpending) {
      const ctx = document.getElementById('distributionChart').getContext('2d');
      
      if (distributionChart) distributionChart.destroy();
      
      const labels = Object.keys(categorySpending);
      const data = labels.map(cat => categorySpending[cat]);
      const colors = ['#667eea', '#764ba2', '#f093fb', '#4facfe', '#00f2fe', '#45b7d1', '#f093fb', '#a78bfa'];

      distributionChart = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: labels,
          datasets: [{
            data: data,
            backgroundColor: colors,
            borderColor: '#fff',
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: { legend: { position: 'right' } }
        }
      });
    }

    function getCategoryEmoji(category) {
      const emojis = {
        'Food': 'üçî', 'Travel': '‚úàÔ∏è', 'Rent': 'üè†', 'Shopping': 'üõçÔ∏è',
        'Salary': 'üíº', 'Entertainment': 'üé¨', 'Bills': 'üìÑ', 'Health': 'üè•', 'Other': 'üìå'
      };
      return emojis[category] || 'üìå';
    }

    function getCurrency() {
      return localStorage.getItem('currency') || '‚Çπ';
    }

    function getDaysSinceFirstTransaction() {
      if (allTransactions.length === 0) return 1;
      const dates = allTransactions.map(t => new Date(t.date).getTime());
      const oldest = Math.min(...dates);
      return Math.ceil((Date.now() - oldest) / (24 * 60 * 60 * 1000));
    }

    // Event listeners
    document.getElementById('addTransactionBtn').addEventListener('click', () => {
      document.getElementById('transactionForm').reset();
      document.getElementById('transactionDate').valueAsDate = new Date();
      openModal('transactionModal');
    });

    document.getElementById('transactionForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const transaction = {
        type: document.getElementById('transactionType').value,
        category: document.getElementById('transactionCategory').value,
        title: document.getElementById('transactionTitle').value,
        amount: parseFloat(document.getElementById('transactionAmount').value),
        date: document.getElementById('transactionDate').value,
        notes: document.getElementById('transactionNotes').value,
        timestamp: new Date()
      };

      try {
        await addDoc(collection(db, `users/${currentUser.uid}/transactions`), transaction);
        closeModal('transactionModal');
        showNotification('Transaction added successfully!');
      } catch (error) {
        console.error('Error adding transaction:', error);
      }
    });

    document.getElementById('filterType').addEventListener('change', updateTransactionsList);
    document.getElementById('filterDate').addEventListener('change', updateTransactionsList);
    document.getElementById('searchTransactions').addEventListener('input', updateTransactionsList);

    document.getElementById('logoutBtn').addEventListener('click', () => signOut(auth));
    document.getElementById('logoutBtnMobile').addEventListener('click', () => signOut(auth));

    // Navigation
    document.querySelectorAll('.nav-item').forEach(item => {
      item.addEventListener('click', () => {
        const pageName = item.dataset.page;
        switchPage(pageName);
        
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        item.classList.add('active');
      });
    });

    function switchPage(pageName) {
      document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
      document.getElementById(pageName).classList.add('active');
    }

    // Modal functions
    function openModal(modalId) {
      document.getElementById(modalId).classList.add('open');
    }

    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('open');
    }

    function showNotification(message) {
      const notification = document.createElement('div');
      notification.className = 'notification';
      notification.textContent = message;
      document.body.appendChild(notification);
      setTimeout(() => notification.remove(), 3000);
    }

    async function deleteTransaction(transactionId) {
      if (confirm('Delete this transaction?')) {
        try {
          await deleteDoc(doc(db, `users/${currentUser.uid}/transactions`, transactionId));
          showNotification('Transaction deleted!');
        } catch (error) {
          console.error('Error deleting:', error);
        }
      }
    }

    // Settings
    document.getElementById('currencySelect').addEventListener('change', (e) => {
      localStorage.setItem('currency', e.target.value);
      updateAnalytics();
    });

    document.getElementById('currencySelect').value = getCurrency();

    document.getElementById('exportCSVBtn').addEventListener('click', () => {
      if (allTransactions.length === 0) {
        alert('No transactions to export!');
        return;
      }

      let csv = 'Date,Type,Category,Title,Amount,Notes\n';
      allTransactions.forEach(t => {
        csv += `${t.date},${t.type},${t.category},"${t.title}",${t.amount},"${t.notes || ''}"\n`;
      });

      const blob = new Blob([csv], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'transactions.csv';
      a.click();
      window.URL.revokeObjectURL(url);
    });

    document.getElementById('deleteAllBtn').addEventListener('click', async () => {
      if (confirm('This will delete ALL transactions. Are you sure?')) {
        try {
          for (let transaction of allTransactions) {
            await deleteDoc(doc(db, `users/${currentUser.uid}/transactions`, transaction.id));
          }
          showNotification('All data deleted!');
          allTransactions = [];
          updateAnalytics();
        } catch (error) {
          console.error('Error deleting all:', error);
        }
      }
    });

    document.getElementById('addRecurringBtn').addEventListener('click', () => {
      openModal('recurringModal');
    });

    document.getElementById('recurringForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      // Recurring logic here
      closeModal('recurringModal');
      showNotification('Recurring payment added!');
    });

    function showAuthPage() {
      window.location.href = '/auth.html';
    }
  </script>
</body>
</html>
