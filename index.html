<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TrackIT - Expense Tracker</title>
  <link rel="icon" type="image/png" href="logo.png" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

  <style>
    /* ---------- Theme variables ---------- */
    :root{
      --bg: #f5f5f5;
      --panel: #ffffff;
      --muted: #666666;
      --text: #333333;
      --brand: #ff6b35;
      --income: #10b981;
      --expense: #ef4444;
      --shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    body.dark{
      --bg: #0b0d12;
      --panel: #0f1720;
      --muted: #9aa3b2;
      --text: #e6eef8;
      --brand: #ff8a5b;
      --shadow: 0 6px 18px rgba(0,0,0,0.6);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); overflow-x: hidden; }
    .header { background: var(--panel); padding: 12px 0; box-shadow: var(--shadow); position: fixed; top: 0; left: 0; right: 0; z-index: 100; }
    .header-content { display: flex; justify-content: space-between; align-items: center; padding: 0 20px; max-width: 1200px; margin: 0 auto; }
    .header-left { display: flex; align-items: center; gap: 12px; }
    .menu-toggle { background: none; border: none; font-size: 22px; cursor: pointer; color: var(--brand); padding: 8px; border-radius: 8px; transition: all 0.2s; }
    .logo { display:flex; align-items:center; gap:8px; font-size:20px; font-weight:700; color:var(--brand); letter-spacing:1px; cursor:pointer; }
    .logo-img { width:28px; height:28px; object-fit:contain; border-radius:6px; }
    .notification-bell { position: relative; font-size: 20px; cursor: pointer; padding: 8px; color:var(--muted); }
    .notification-dot { position: absolute; top: 0; right: 0; width: 10px; height: 10px; background: var(--expense); border-radius: 50%; display: none; }
    .notification-dot.show { display: block; }

    /* Sidebar */
    .sidebar { position: fixed; top: 0; left: -300px; width: 300px; height: 100vh; background: var(--panel); box-shadow: 4px 0 12px rgba(0,0,0,0.08); z-index: 200; transition: left 0.28s ease; overflow-y: auto; }
    .sidebar.open { left: 0; }
    .sidebar-header { padding: 18px; border-bottom: 1px solid rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; }
    .sidebar-title { font-size: 20px; font-weight: 700; color: var(--brand); display:flex; gap:8px; align-items:center; }
    .close-sidebar { background: none; border: none; font-size: 22px; cursor: pointer; color: var(--muted); padding: 6px; border-radius: 6px; }
    .sidebar-nav { padding: 16px 0; }
    .nav-item { display: flex; align-items: center; gap: 12px; padding: 12px 18px; color: var(--muted); font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s; border-left: 4px solid transparent; }
    .nav-item:hover { background: rgba(255,107,53,0.05); color: var(--brand); border-left-color: var(--brand); }
    .nav-item.active { background: rgba(255,107,53,0.06); color: var(--brand); border-left-color: var(--brand); }
    .nav-icon { font-size: 18px; width: 24px; text-align: center; }

    .sidebar-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 150; display: none; opacity: 0; transition: opacity 0.3s; }
    .sidebar-overlay.show { display: block; opacity: 1; }

    .container { margin-top: 72px; padding: 20px; max-width: 1200px; margin-left: auto; margin-right: auto; padding-bottom: 120px; }

    .sidebar-user { padding: 18px; border-top: 1px solid rgba(0,0,0,0.04); display: none; flex-direction: column; gap:8px; }
    .sidebar-user .name { font-weight:700; color:var(--text); overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .sidebar-user .logout { width:100%; padding:10px 12px; border-radius:8px; border:none; background:#f0f0f0; cursor:pointer; font-weight:700; }

    /* Notification Panel */
    .notification-panel { position: fixed; top: 72px; right: -380px; width: 380px; max-height: calc(100vh - 72px); background: var(--panel); box-shadow: -4px 0 12px rgba(0,0,0,0.1); z-index: 180; transition: right 0.28s ease; overflow-y: auto; }
    .notification-panel.show { right: 12px; }
    .notification-header { padding: 14px; border-bottom: 1px solid rgba(0,0,0,0.05); font-weight: 700; color: var(--text); }
    .notification-item { padding: 12px 14px; border-bottom: 1px solid rgba(0,0,0,0.03); border-left: 4px solid var(--brand); cursor: pointer; }
    .notification-item.warning { border-left-color: var(--expense); }
    .notification-item.info { border-left-color: #3b82f6; color:var(--muted); }
    .notification-title { font-weight:700; margin-bottom:6px; }
    .notification-message { font-size:13px; color:var(--muted); }

    /* Cards, panels */
    .summary-section { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 16px; margin-bottom: 20px; }
    .summary-card { background: var(--panel); padding: 18px; border-radius: 12px; box-shadow: var(--shadow); transition: transform 0.25s; cursor:pointer; }
    .summary-card:hover { transform: translateY(-6px); }
    .summary-label { font-size:13px;color:var(--muted); font-weight:600; margin-bottom:8px; text-transform:uppercase; }
    .summary-value { font-size:26px; font-weight:800; color:var(--text); }
    .summary-value.income { color: var(--income); }
    .summary-value.expense { color: var(--expense); }
    .summary-value.balance { color: var(--brand); }

    .section { background: var(--panel); padding: 18px; border-radius: 12px; box-shadow: var(--shadow); margin-bottom: 18px; }
    .section-title { font-size:16px; font-weight:700; color:var(--text); margin-bottom:12px; display:flex; align-items:center; gap:8px; }
    .section-title::before { content:''; width:4px;height:20px;background:var(--brand);border-radius:2px; }

    .filters { display:flex; gap:8px; margin-bottom:12px; flex-wrap:wrap; }
    .filter-btn { padding:8px 12px; background: var(--panel); border: 2px solid rgba(0,0,0,0.04); border-radius:8px; font-size:13px; font-weight:600; cursor:pointer; }
    .filter-btn.active { background: var(--brand); color:#fff; border-color:var(--brand); }

    .search-box { width:100%; padding:10px 14px; border-radius:8px; border:2px solid rgba(0,0,0,0.04); font-size:14px; margin-bottom:12px; }

    .transaction-list { display:flex; flex-direction:column; gap:10px; }
    .transaction-item { display:flex; justify-content:space-between; align-items:center; padding:12px; background: rgba(0,0,0,0.02); border-radius:10px; border-left:4px solid var(--brand); }
    .transaction-item.income { border-left-color: var(--income); background: rgba(16,185,129,0.04); }
    .transaction-item.expense { border-left-color: var(--expense); background: rgba(239,68,68,0.03); }
    .transaction-info { flex:1; min-width:0; }
    .transaction-title { font-weight:700; color:var(--text); margin-bottom:6px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .transaction-meta { display:flex; gap:8px; align-items:center; color:var(--muted); font-size:13px; }
    .transaction-category { padding:4px 8px; border-radius:6px; font-weight:600; font-size:12px; background:var(--brand); color:white; }
    .transaction-amount { font-weight:800; min-width:100px; text-align:right; }

    .add-btn { position: fixed; bottom: 26px; right: 26px; width:56px; height:56px; background: var(--brand); color:white; border:none; border-radius:50%; font-size:28px; cursor:pointer; box-shadow: 0 8px 28px rgba(255,107,53,0.18); z-index:50; display:flex; align-items:center; justify-content:center; }
    .modal-overlay { display:none; position:fixed; inset:0; background: rgba(0,0,0,0.5); z-index:300; align-items:center; justify-content:center; padding:20px; }
    .modal-overlay.show { display:flex; }
    .modal { background: var(--panel); padding:20px; border-radius:12px; box-shadow: var(--shadow); max-width:560px; width:100%; max-height:90vh; overflow-y:auto; }
    .modal-header { font-size:20px; font-weight:800; margin-bottom:12px; }

    .form-group { margin-bottom:14px; }
    .form-label { display:block; margin-bottom:6px; font-weight:700; color:var(--text); }
    .form-input, .form-select, .form-textarea { width:100%; padding:10px 12px; border-radius:8px; border:1px solid rgba(0,0,0,0.06); background:transparent; color:var(--text); }
    .form-textarea { min-height:70px; resize:vertical; }
    .form-actions { display:flex; gap:8px; margin-top:10px; }
    .btn { padding:10px 12px; border-radius:8px; border:none; font-weight:700; cursor:pointer; }
    .btn-primary { background:var(--brand); color:#fff; }
    .btn-secondary { background: rgba(0,0,0,0.04); color:var(--text); }

    .page-section { display:none; animation: fadeIn 0.18s ease; }
    .page-section.active { display:block; }

    /* Auth page */
    #auth-page { position: fixed; inset: 0; background: linear-gradient(120deg,#fff 0%, #fff 60%, #fff); display:flex; align-items:center; justify-content:center; z-index:400; }
    #auth-card { width:100%; max-width:920px; background: var(--panel); border-radius:12px; box-shadow: var(--shadow); overflow:hidden; display:flex; }
    #auth-left { padding:36px; background: linear-gradient(180deg,var(--brand), #ff9b73); color:white; flex:1; display:flex; flex-direction:column; justify-content:center; gap:12px; }
    #auth-right { padding:28px; flex:1; }
    .auth-logo { width:48px; height:48px; object-fit:contain; border-radius:8px; background:rgba(255,255,255,0.06); padding:6px; }
    @media (max-width:900px) { #auth-card{flex-direction:column} #auth-left{display:none} }

    .hidden { display:none !important; }

    /* small screens */
    @media (max-width:700px) {
      #user-info, #logout-btn { display:none !important; }
      .sidebar-user { display:flex; }
    }

  </style>
</head>
<body>

  <!-- Sidebar overlay -->
  <div class="sidebar-overlay" id="sidebar-overlay" onclick="closeSidebar()"></div>

  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-title"><img src="logo.png" class="logo-img" alt="logo"> TrackIT</div>
      <button class="close-sidebar" onclick="closeSidebar()">✕</button>
    </div>
    <nav class="sidebar-nav">
      <div class="nav-item active" onclick="switchPage('home')"><span class="nav-icon">🏠</span><span>Home</span></div>
      <div class="nav-item" onclick="switchPage('history')"><span class="nav-icon">📋</span><span>History</span></div>
      <div class="nav-item" onclick="switchPage('analytics')"><span class="nav-icon">📊</span><span>Analytics</span></div>
      <div class="nav-item" onclick="switchPage('recurring')"><span class="nav-icon">🔄</span><span>Recurring</span></div>
      <div class="nav-item" onclick="switchPage('budget')"><span class="nav-icon">💰</span><span>Budget</span></div>
      <div class="nav-item" onclick="switchPage('settings')"><span class="nav-icon">⚙️</span><span>Settings</span></div>
    </nav>

    <div class="sidebar-user" id="sidebar-user-section" aria-hidden="true">
      <div class="name" id="sidebar-user-name"></div>
      <button id="sidebar-logout-btn" class="logout">Logout</button>
    </div>
  </aside>

  <!-- Header -->
  <header class="header">
    <div class="header-content">
      <div class="header-left">
        <button class="menu-toggle" onclick="openSidebar()">☰</button>
        <div class="logo" onclick="switchPage('home'); closeSidebar();">
          <img src="logo.png" class="logo-img" alt="logo">
          <span>TrackIT</span>
        </div>
      </div>
      <div style="display:flex;align-items:center;gap:10px;">
        <div class="notification-bell" onclick="toggleNotifications()">🔔<div class="notification-dot" id="notification-dot"></div></div>
        <div id="auth-controls" style="display:flex;gap:8px;align-items:center;">
          <button id="login-open-btn" class="btn btn-secondary" style="display:none;">Sign in</button>
          <button id="logout-btn" class="btn btn-secondary hidden">Logout</button>
          <div id="user-info" class="hidden"></div>
        </div>
      </div>
    </div>
  </header>

  <!-- Notification Panel -->
  <div class="notification-panel" id="notification-panel">
    <div class="notification-header">Notifications</div>
    <div id="notifications-list"></div>
  </div>

  <!-- Main Container -->
  <div class="container">
    <!-- Home -->
    <div id="page-home" class="page-section active">
      <div class="summary-section">
        <div class="summary-card" onclick="showIncome()">
          <div class="summary-label">Total Income</div>
          <div class="summary-value income" id="total-income">₹0</div>
        </div>
        <div class="summary-card" onclick="showExpense()">
          <div class="summary-label">Total Expense</div>
          <div class="summary-value expense" id="total-expense">₹0</div>
        </div>
        <div class="summary-card" onclick="openBudgetPage()">
          <div class="summary-label">Current Balance</div>
          <div class="summary-value balance" id="balance">₹0</div>
        </div>
      </div>

      <div class="section">
        <h2 class="section-title">Budget Usage by Category</h2>
        <div class="budget-home-section" id="budget-home"></div>
      </div>

      <div class="section">
        <h2 class="section-title">Recent Transactions</h2>
        <div class="transaction-list" id="recent-transactions"></div>
      </div>
    </div>

    <!-- History -->
    <div id="page-history" class="page-section">
      <div class="section">
        <h2 class="section-title">All Transactions</h2>
        <input type="text" class="search-box" id="search-box" placeholder="Search transactions...">
        <div class="filters">
          <button class="filter-btn active" onclick="filterTransactions('all', event)">All</button>
          <button class="filter-btn" onclick="filterTransactions('income', event)">Income</button>
          <button class="filter-btn" onclick="filterTransactions('expense', event)">Expense</button>
        </div>
        <div class="filters">
          <button class="filter-btn" onclick="filterByDate('today', event)">Today</button>
          <button class="filter-btn" onclick="filterByDate('week', event)">This Week</button>
          <button class="filter-btn" onclick="filterByDate('month', event)">This Month</button>
          <button class="filter-btn" onclick="filterByDate('all', event)">All Time</button>
        </div>
        <div class="transaction-list" id="all-transactions"></div>
      </div>
    </div>

    <!-- Analytics -->
    <div id="page-analytics" class="page-section">
      <div class="section">
        <h2 class="section-title">Spending Distribution (Pie Chart)</h2>
        <div class="chart-container" style="height:320px;"><canvas id="pie-chart"></canvas></div>
      </div>

      <div class="section">
        <h2 class="section-title">Monthly Trend (Line Chart)</h2>
        <div class="chart-container" style="height:320px;"><canvas id="line-chart"></canvas></div>
      </div>

      <div class="stats-grid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin-top:12px;">
        <div class="stat-card"><div class="stat-label">Total Transactions</div><div class="stat-value" id="stat-total">0</div></div>
        <div class="stat-card"><div class="stat-label">Avg Daily Expense</div><div class="stat-value" id="stat-avg">₹0</div></div>
        <div class="stat-card"><div class="stat-label">This Month</div><div class="stat-value" id="stat-month">₹0</div></div>
        <div class="stat-card"><div class="stat-label">Last 7 Days</div><div class="stat-value" id="stat-week">₹0</div></div>
      </div>
    </div>

    <!-- Recurring -->
    <div id="page-recurring" class="page-section">
      <div class="section">
        <h2 class="section-title">Recurring Payments</h2>
        <button class="btn btn-primary" onclick="openRecurringModal()" style="margin-bottom: 12px; width:100%;">+ Add Recurring Payment</button>
        <div id="recurring-list"></div>
      </div>
    </div>

    <!-- Budget -->
    <div id="page-budget" class="page-section">
      <div class="section">
        <h2 class="section-title">Monthly Budget Tracker</h2>
        <div style="display:flex;gap:10px;margin-bottom:12px;">
          <input type="number" class="form-input" id="budget-amount" placeholder="Set monthly budget (₹)" min="0">
          <button class="btn btn-primary" onclick="setBudget()">Set Budget</button>
        </div>
        <div class="budget-home-section" id="budget-progress"></div>
      </div>

      <div class="section">
        <h2 class="section-title">Category-wise Budget</h2>
        <div id="category-budget-list"></div>
        <button class="btn btn-primary" onclick="saveCategoryBudgets()" style="margin-top:12px;width:100%;">Save Category Budgets</button>
      </div>

      <div class="section">
        <h2 class="section-title">Spending Goal</h2>
        <div style="display:flex;gap:10px;margin-bottom:12px;">
          <input type="number" class="form-input" id="goal-amount" placeholder="Set savings goal (₹)" min="0">
          <button class="btn btn-primary" onclick="setGoal()">Set Goal</button>
        </div>
        <div class="budget-home-section" id="goal-progress"></div>
      </div>
    </div>

    <!-- Settings -->
    <div id="page-settings" class="page-section">
      <div class="section">
        <h2 class="section-title">Theme</h2>
        <div style="display:flex;gap:10px;align-items:center;">
          <label style="font-weight:700;">Dark Mode</label>
          <input type="checkbox" id="dark-mode-toggle" />
        </div>
      </div>

      <div class="section">
        <h2 class="section-title">Manage Categories</h2>
        <div style="display:flex;gap:8px;margin-bottom:10px;">
          <input id="new-category-name" class="form-input" placeholder="New category name (e.g. Tips)" />
          <select id="new-category-type" class="form-select" style="width:140px;">
            <option value="expense">Expense</option>
            <option value="income">Income</option>
            <option value="both">Both</option>
          </select>
          <button class="btn btn-primary" onclick="addCategory()">Add</button>
        </div>
        <div id="categories-list" style="display:flex;flex-direction:column;gap:8px;"></div>
      </div>

      <div class="section">
        <h2 class="section-title">Data Management</h2>
        <div class="filters">
          <button class="export-btn" onclick="exportCSV()">📥 CSV</button>
          <button class="export-btn" onclick="exportJSON()">📥 JSON</button>
          <button class="export-btn" onclick="importData()">📤 Import</button>
          <input type="file" id="import-file" accept=".json,.csv" style="display:none" onchange="handleImport(event)">
        </div>
      </div>

      <div class="section">
        <h2 class="section-title">Currency</h2>
        <select class="form-select" id="currency-select" onchange="changeCurrency()">
          <option value="₹">₹ (Rupee)</option>
          <option value="$">$ (Dollar)</option>
          <option value="€">€ (Euro)</option>
          <option value="£">£ (Pound)</option>
        </select>
      </div>

      <div class="section">
        <h2 class="section-title">Danger Zone</h2>
        <button class="btn btn-secondary" style="background:#ef4444;color:white;width:100%;" onclick="resetData()">🗑️ Delete All Data</button>
      </div>
    </div>
  </div>

  <button class="add-btn" onclick="openModal()">+</button>

  <!-- Transaction Modal -->
  <div class="modal-overlay" id="modal-overlay" onclick="closeModalOnOverlay(event)">
    <div class="modal">
      <h2 class="modal-header" id="modal-title">Add Transaction</h2>
      <form id="transaction-form" onsubmit="handleSubmit(event)">
        <div class="form-group"><label class="form-label">Type</label>
          <select class="form-select" id="type" required>
            <option value="expense">Expense</option>
            <option value="income">Income</option>
          </select>
        </div>
        <div class="form-group"><label class="form-label">Title</label><input type="text" class="form-input" id="title" required></div>
        <div class="form-group"><label class="form-label">Amount</label><input type="number" class="form-input" id="amount" step="0.01" min="0" required></div>
        <div class="form-group"><label class="form-label">Category</label>
          <select class="form-select" id="category" required></select>
        </div>
        <div class="form-group"><label class="form-label">Date</label><input type="date" class="form-input" id="date" required></div>
        <div class="form-group"><label class="form-label">Notes</label><textarea class="form-textarea" id="notes"></textarea></div>
        <div class="form-actions"><button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button><button type="submit" class="btn btn-primary">Save</button></div>
      </form>
    </div>
  </div>

  <!-- Recurring Modal -->
  <div class="modal-overlay" id="recurring-modal" onclick="closeRecurringModal(event)">
    <div class="modal">
      <h2 class="modal-header">Add Recurring Payment</h2>
      <form id="recurring-form" onsubmit="handleRecurringSubmit(event)">
        <div class="form-group"><label class="form-label">Title</label><input type="text" class="form-input" id="recurring-title" required></div>
        <div class="form-group"><label class="form-label">Amount</label><input type="number" class="form-input" id="recurring-amount" step="0.01" min="0" required></div>
        <div class="form-group"><label class="form-label">Category</label><select class="form-select" id="recurring-category" required></select></div>
        <div class="form-group"><label class="form-label">Frequency</label><select class="form-select" id="recurring-frequency" required><option value="weekly">Weekly</option><option value="monthly">Monthly</option><option value="quarterly">Quarterly</option><option value="yearly">Yearly</option></select></div>
        <div class="form-group"><label class="form-label">Due Date (day of month)</label><input type="number" class="form-input" id="recurring-duedate" min="1" max="31" required></div>
        <div class="form-group"><div style="display:flex;align-items:center;gap:8px;"><input type="checkbox" id="recurring-notify" checked><label class="form-label" for="recurring-notify" style="margin:0;padding:0;">Notify before due date</label></div></div>
        <div class="form-actions"><button type="button" class="btn btn-secondary" onclick="closeRecurringModal()">Cancel</button><button type="submit" class="btn btn-primary">Add</button></div>
      </form>
    </div>
  </div>

  <!-- ---------- AUTH PAGE (shown on first visit / when signed out) ---------- -->
  <div id="auth-page" style="display:none;">
    <div id="auth-card">
      <div id="auth-left">
        <div style="display:flex;align-items:center;gap:10px;">
          <img src="logo.png" class="auth-logo" alt="logo">
          <h1 style="margin:0;">TrackIT</h1>
        </div>
        <p style="max-width:320px;">Sign in or create an account to keep your transactions safe and sync across devices.</p>
        <div style="margin-top:20px;font-weight:700;">Features:</div>
        <ul style="margin-top:10px;list-style:disc;padding-left:18px;">
          <li>Secure sign-in (email/password + Google)</li>
          <li>Sync transactions, budgets, recurring payments</li>
          <li>Real-time analytics & notifications</li>
        </ul>
      </div>

      <div id="auth-right">
        <div class="auth-form">
          <div style="display:flex;gap:12px;margin-bottom:14px;">
            <button id="switch-signin" class="btn btn-secondary" style="flex:1;">Sign In</button>
            <button id="switch-signup" class="btn btn-primary" style="flex:1;">Sign Up</button>
          </div>

          <!-- Sign-in form -->
          <form id="signin-form" style="display:block;">
            <div class="form-group"><label>Email</label><input type="email" id="signin-email" required></div>
            <div class="form-group"><label>Password</label><input type="password" id="signin-password" required></div>
            <div style="display:flex;gap:8px;align-items:center;">
              <button id="signin-btn" class="btn btn-primary" type="button">Sign In</button>
              <button id="google-signin-btn" class="btn btn-secondary" type="button">Sign in with Google</button>
            </div>
            <div style="margin-top:10px;"><button id="forgot-btn" class="link-btn" type="button">Forgot password?</button></div>
          </form>

          <!-- Sign-up form -->
          <form id="signup-form" style="display:none;">
            <div class="form-group"><label>Full name</label><input type="text" id="signup-name" required></div>
            <div class="form-group"><label>Email</label><input type="email" id="signup-email" required></div>
            <div class="form-group"><label>Password</label><input type="password" id="signup-password" required></div>
            <div style="display:flex;gap:8px;align-items:center;">
              <button id="signup-btn" class="btn btn-primary" type="button">Create account</button>
              <button id="google-signup-btn" class="btn btn-secondary" type="button">Sign up with Google</button>
            </div>
          </form>

          <div id="auth-message" class="small" style="margin-top:12px;color:var(--expense);"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ---------- Firebase + App Logic ---------- -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import {
      getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc, onSnapshot, setDoc, query, orderBy
    } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";
    import {
      getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword,
      sendPasswordResetEmail, signInWithPopup, GoogleAuthProvider, signOut, updateProfile
    } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";

    // ---------- FIREBASE CONFIG (your config) ----------
    const firebaseConfig = {
      apiKey: "AIzaSyAhGtlmGJhDVlA019Mp9VaWFeqCZLcmvRw",
      authDomain: "trackit-9b1b3.firebaseapp.com",
      projectId: "trackit-9b1b3",
      storageBucket: "trackit-9b1b3.firebasestorage.app",
      messagingSenderId: "1069567955371",
      appId: "1:1069567955371:web:ac13b2ec4d02b0a2c102ee",
      measurementId: "G-9CHN828L1R"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    // ---------- App State ----------
    let uid = null;
    let transactions = [];
    let recurringPayments = [];
    // categories will be array of objects: { name: 'Food', type: 'expense'|'income'|'both' }
    let categories = [
      {name:'Food', type:'expense'},
      {name:'Travel', type:'expense'},
      {name:'Rent', type:'expense'},
      {name:'Shopping', type:'expense'},
      {name:'Salary', type:'income'},
      {name:'Entertainment', type:'expense'},
      {name:'Bills', type:'expense'},
      {name:'Health', type:'expense'},
      {name:'Other', type:'both'}
    ];
    let monthlyBudget = 0;
    let categoryBudgets = {};
    let savingsGoal = 0;
    let currency = "₹";
    let notifications = [];
    let currentFilter = 'all';
    let currentDateFilter = 'all';
    let editingIndex = -1; // when editing, store txn id
    let pieChartInstance = null;
    let lineChartInstance = null;
    let theme = 'light';

    // Firestore listeners
    let unsubTransactions = null;
    let unsubRecurring = null;
    let unsubSettings = null;

    // DOM refs
    const authPage = document.getElementById('auth-page');
    const signinForm = document.getElementById('signin-form');
    const signupForm = document.getElementById('signup-form');
    const signinEmail = document.getElementById('signin-email');
    const signinPassword = document.getElementById('signin-password');
    const signupName = document.getElementById('signup-name');
    const signupEmail = document.getElementById('signup-email');
    const signupPassword = document.getElementById('signup-password');
    const signinBtn = document.getElementById('signin-btn');
    const signupBtn = document.getElementById('signup-btn');
    const forgotBtn = document.getElementById('forgot-btn');
    const googleSigninBtn = document.getElementById('google-signin-btn');
    const googleSignupBtn = document.getElementById('google-signup-btn');
    const switchSignin = document.getElementById('switch-signin');
    const switchSignup = document.getElementById('switch-signup');
    const authMessage = document.getElementById('auth-message');

    const loginOpenBtn = document.getElementById('login-open-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const userInfo = document.getElementById('user-info');

    const sidebarUserSection = document.getElementById('sidebar-user-section');
    const sidebarUserName = document.getElementById('sidebar-user-name');
    const sidebarLogoutBtn = document.getElementById('sidebar-logout-btn');

    // UI init
    normalizeCategories();
    updateCategoryDropdown(); // populates category selects according to current type selection
    renderCategoryBudgets();
    renderRecurringList();
    updateUI();
    updateAuthUI(false);
    applyTheme(); // apply default/light

    // ---------- Auth Flow ----------
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        uid = user.uid;
        updateAuthUI(true, user);
        await startRealtimeListeners();
      } else {
        uid = null;
        updateAuthUI(false);
        stopRealtimeListeners();
        // reset local states
        transactions = [];
        recurringPayments = [];
        categoryBudgets = {};
        monthlyBudget = 0;
        savingsGoal = 0;
        currency = "₹";
        categories = [
          {name:'Food', type:'expense'},
          {name:'Travel', type:'expense'},
          {name:'Rent', type:'expense'},
          {name:'Shopping', type:'expense'},
          {name:'Salary', type:'income'},
          {name:'Entertainment', type:'expense'},
          {name:'Bills', type:'expense'},
          {name:'Health', type:'expense'},
          {name:'Other', type:'both'}
        ];
        normalizeCategories();
        updateCategoryDropdown();
        renderCategoryBudgets();
        renderRecurringList();
        updateUI();
      }
    });

    function updateAuthUI(loggedIn, user = null) {
      if (loggedIn) {
        authPage.style.display = 'none';
        document.getElementById('logout-btn').classList.remove('hidden');
        document.getElementById('login-open-btn').style.display = 'none';
        userInfo.classList.remove('hidden');
        const display = (user && (user.displayName || user.email)) ? (user.displayName || user.email) : 'Signed in';
        userInfo.textContent = display;
        sidebarUserName.textContent = display;
        sidebarUserSection.style.display = 'flex';
        sidebarUserSection.setAttribute('aria-hidden','false');
      } else {
        authPage.style.display = 'flex';
        document.getElementById('logout-btn').classList.add('hidden');
        document.getElementById('login-open-btn').style.display = 'none';
        userInfo.classList.add('hidden');
        sidebarUserSection.style.display = 'none';
        sidebarUserSection.setAttribute('aria-hidden','true');
      }
    }

    // Switch forms
    switchSignin.addEventListener('click', () => { signinForm.style.display = 'block'; signupForm.style.display = 'none'; authMessage.textContent = ''; });
    switchSignup.addEventListener('click', () => { signinForm.style.display = 'none'; signupForm.style.display = 'block'; authMessage.textContent = ''; });

    // Signup
    signupBtn.addEventListener('click', async () => {
      const name = signupName.value.trim();
      const email = signupEmail.value.trim();
      const pass = signupPassword.value;
      if (!name || !email || !pass) return authMessage.textContent = 'Please fill all fields';
      authMessage.textContent = 'Creating account...';
      try {
        const res = await createUserWithEmailAndPassword(auth, email, pass);
        await updateProfile(res.user, { displayName: name });
        // create default settings
        await setDoc(doc(db, 'users', res.user.uid, 'settings', 'prefs'), {
          categories,
          monthlyBudget: 0,
          categoryBudgets: {},
          savingsGoal: 0,
          currency,
          theme: 'light'
        }, { merge: true });
        authMessage.textContent = '';
      } catch (err) {
        authMessage.textContent = err.message;
      }
    });

    // Signin
    signinBtn.addEventListener('click', async () => {
      const email = signinEmail.value.trim();
      const pass = signinPassword.value;
      if (!email || !pass) return authMessage.textContent = 'Enter email & password';
      authMessage.textContent = 'Signing in...';
      try {
        await signInWithEmailAndPassword(auth, email, pass);
        authMessage.textContent = '';
      } catch (err) {
        authMessage.textContent = err.message;
      }
    });

    // Google sign-in
    googleSigninBtn.addEventListener('click', async () => {
      try { await signInWithPopup(auth, provider); } catch (err) { authMessage.textContent = err.message; }
    });
    googleSignupBtn.addEventListener('click', async () => {
      try { await signInWithPopup(auth, provider); } catch (err) { authMessage.textContent = err.message; }
    });

    // Forgot password
    forgotBtn.addEventListener('click', async () => {
      const email = signinEmail.value.trim();
      if (!email) return authMessage.textContent = 'Enter your email to reset';
      try {
        await sendPasswordResetEmail(auth, email);
        authMessage.style.color = 'green';
        authMessage.textContent = 'Reset email sent. Check your inbox.';
      } catch (err) {
        authMessage.style.color = 'red';
        authMessage.textContent = err.message;
      }
    });

    // Logout
    logoutBtn.addEventListener('click', async () => { await signOut(auth); });
    sidebarLogoutBtn.addEventListener('click', async () => { await signOut(auth); closeSidebar(); });

    // ---------- Real-time listeners ----------
    async function startRealtimeListeners() {
      if (!uid) return;
      // transactions
      const txCol = collection(db, "users", uid, "transactions");
      const txQuery = query(txCol, orderBy("date","desc"));
      unsubTransactions = onSnapshot(txQuery, snapshot => {
        transactions = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
        updateUI();
      });

      // recurring
      const recCol = collection(db, "users", uid, "recurring");
      unsubRecurring = onSnapshot(recCol, snapshot => {
        recurringPayments = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
        renderRecurringList();
        generateNotifications();
      });

      // settings
      const settingsDoc = doc(db, "users", uid, "settings", "prefs");
      unsubSettings = onSnapshot(settingsDoc, snapshot => {
        const s = snapshot.data();
        if (s) {
          // handle categories format (string array or object array)
          if (Array.isArray(s.categories)) {
            categories = normalizeIncomingCategories(s.categories);
          }
          monthlyBudget = s.monthlyBudget || 0;
          categoryBudgets = s.categoryBudgets || {};
          savingsGoal = s.savingsGoal || 0;
          currency = s.currency || currency;
          theme = s.theme || theme;
        }
        normalizeCategories();
        updateCategoryDropdown();
        renderCategoryBudgets();
        updateUI();
        applyTheme();
        generateNotifications();
      });
    }

    function stopRealtimeListeners() {
      if (unsubTransactions) { unsubTransactions(); unsubTransactions = null; }
      if (unsubRecurring) { unsubRecurring(); unsubRecurring = null; }
      if (unsubSettings) { unsubSettings(); unsubSettings = null; }
    }

    // ---------- Firestore helpers ----------
    async function writeSettingsToFirestore() {
      if (!uid) return; // we'll allow local changes too if logged out
      const settingsRef = doc(db, "users", uid, "settings", "prefs");
      // store categories as objects for full fidelity
      await setDoc(settingsRef, {
        categories,
        monthlyBudget,
        categoryBudgets,
        savingsGoal,
        currency,
        theme
      }, { merge: true });
    }

    async function addTransactionToFirestore(txn) {
      if (!uid) throw new Error('Not authenticated');
      const colRef = collection(db, "users", uid, "transactions");
      await addDoc(colRef, txn);
    }
    async function updateTransactionInFirestore(txnId, txnObj) {
      if (!uid) throw new Error('Not authenticated');
      const docRef = doc(db, "users", uid, "transactions", txnId);
      await updateDoc(docRef, txnObj);
    }
    async function deleteTransactionFromFirestore(txnId) {
      if (!uid) throw new Error('Not authenticated');
      const docRef = doc(db, "users", uid, "transactions", txnId);
      await deleteDoc(docRef);
    }
    async function addRecurringToFirestore(r) {
      if (!uid) throw new Error('Not authenticated');
      const colRef = collection(db, "users", uid, "recurring");
      await addDoc(colRef, r);
    }
    async function deleteRecurringFromFirestore(id) {
      if (!uid) throw new Error('Not authenticated');
      await deleteDoc(doc(db, "users", uid, "recurring", id));
    }

    // ---------- UI update functions ----------
    function updateUI() {
      updateSummary();
      updateRecentTransactions();
      updateAllTransactions();
      updateBudgetHome();
      generateNotifications();
      updateAnalytics();
    }

    function updateSummary() {
      let totalIncome = 0, totalExpense = 0;
      transactions.forEach(txn => {
        if (txn.type === 'income') totalIncome += parseFloat(txn.amount || 0);
        else totalExpense += parseFloat(txn.amount || 0);
      });
      const balance = totalIncome - totalExpense;
      document.getElementById('balance').textContent = currency + (balance).toLocaleString('en-IN', {maximumFractionDigits: 2});
      document.getElementById('total-income').textContent = currency + totalIncome.toLocaleString('en-IN', {maximumFractionDigits: 2});
      document.getElementById('total-expense').textContent = currency + totalExpense.toLocaleString('en-IN', {maximumFractionDigits: 2});
    }

    function updateBudgetHome() {
      const now = new Date();
      const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
      const categoryTotals = {};
      transactions.filter(t => t.type === 'expense' && new Date(t.date) >= monthStart)
        .forEach(t => { categoryTotals[t.category] = (categoryTotals[t.category] || 0) + parseFloat(t.amount || 0); });

      const container = document.getElementById('budget-home');
      container.innerHTML = Object.entries(categoryTotals)
        .sort((a,b) => b[1] - a[1])
        .slice(0,6)
        .map(([cat, spent]) => {
          const budget = categoryBudgets[cat] || 0;
          const percent = budget > 0 ? (spent / budget * 100) : 0;
          const isWarning = percent > 80;
          return `
            <div class="budget-home-item ${isWarning ? 'warning' : ''}">
              <div>
                <div class="budget-home-label">${cat}</div>
                <div class="budget-home-bar" style="background: rgba(0,0,0,0.04); border-radius:4px; overflow:hidden; margin-top:6px;">
                  <div class="budget-home-bar-fill ${isWarning ? 'warning' : ''}" style="width: ${Math.min(percent,100)}%; height:8px; background:var(--brand);"></div>
                </div>
              </div>
              <div class="budget-home-percent">${percent.toFixed(0)}%</div>
            </div>
          `;
        }).join('') || '<div style="color:var(--muted);padding:12px;">No expense data yet for this month.</div>';
    }

    function renderTransaction(txn) {
      const amount = parseFloat(txn.amount || 0).toLocaleString('en-IN', {maximumFractionDigits: 2});
      const sign = txn.type === 'income' ? '+' : '-';
      const formattedDate = txn.date ? new Date(txn.date).toLocaleDateString('en-IN', { day: 'numeric', month: 'short', year: 'numeric' }) : '';
      return `
        <div class="transaction-item ${txn.type}">
          <div class="transaction-info">
            <div class="transaction-title">${escapeHtml(txn.title)}</div>
            <div class="transaction-meta">
              <span class="transaction-category">${escapeHtml(txn.category)}</span>
              <span class="transaction-date">${formattedDate}</span>
            </div>
          </div>
          <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px;">
            <div class="transaction-amount ${txn.type}">${sign}${currency}${amount}</div>
            <div class="transaction-actions">
              <button class="action-btn" onclick="editTransaction('${txn.id}')">✏️</button>
              <button class="action-btn" onclick="deleteTransaction('${txn.id}')">🗑️</button>
            </div>
          </div>
        </div>
      `;
    }

    function updateRecentTransactions() {
      const container = document.getElementById('recent-transactions');
      const recent = [...transactions].sort((a,b)=> new Date(b.date) - new Date(a.date)).slice(0,6);
      if (recent.length === 0) {
        container.innerHTML = '<div style="color:var(--muted);padding:12px;">No transactions yet. Click + to add!</div>';
      } else {
        container.innerHTML = recent.map(txn => renderTransaction(txn)).join('');
      }
    }

    function updateAllTransactions() {
      const container = document.getElementById('all-transactions');
      const searchTerm = (document.getElementById('search-box')?.value || '').toLowerCase();
      let filtered = [...transactions];

      if (currentFilter !== 'all') filtered = filtered.filter(txn => txn.type === currentFilter);

      if (currentDateFilter !== 'all') {
        const now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        filtered = filtered.filter(txn => {
          const txnDate = new Date(txn.date);
          if (currentDateFilter === 'today') return txnDate >= today;
          else if (currentDateFilter === 'week') { const weekAgo = new Date(today); weekAgo.setDate(weekAgo.getDate() - 7); return txnDate >= weekAgo; }
          else if (currentDateFilter === 'month') { const monthStart = new Date(now.getFullYear(), now.getMonth(), 1); return txnDate >= monthStart; }
          return true;
        });
      }

      if (searchTerm) {
        filtered = filtered.filter(txn =>
          (txn.title || '').toLowerCase().includes(searchTerm) ||
          (txn.category || '').toLowerCase().includes(searchTerm)
        );
      }

      filtered.sort((a,b) => new Date(b.date) - new Date(a.date));
      container.innerHTML = filtered.length === 0 ? '<div style="color:var(--muted);padding:12px;">No transactions found</div>' : filtered.map(txn => renderTransaction(txn)).join('');
    }

    // ---------- Forms & CRUD ----------
    async function handleSubmit(event) {
      event.preventDefault();
      if (!uid) return alert('Please log in to add transactions');

      const txn = {
        type: document.getElementById('type').value,
        title: document.getElementById('title').value.trim(),
        amount: parseFloat(document.getElementById('amount').value),
        category: document.getElementById('category').value,
        date: document.getElementById('date').value,
        notes: document.getElementById('notes').value.trim()
      };

      try {
        if (editingIndex && editingIndex !== -1) {
          await updateTransactionInFirestore(editingIndex, txn);
          editingIndex = -1;
        } else {
          await addTransactionToFirestore(txn);
        }
        closeModal();
      } catch (err) {
        alert('Save failed: ' + err.message);
      }
    }

    function editTransaction(id) {
      const txn = transactions.find(t => t.id === id);
      if (!txn) return;
      editingIndex = id;
      document.getElementById('modal-title').textContent = 'Edit Transaction';
      document.getElementById('type').value = txn.type;
      document.getElementById('title').value = txn.title;
      document.getElementById('amount').value = txn.amount;
      // ensure categories are populated for this type
      populateCategoryOptions(txn.type);
      document.getElementById('category').value = txn.category;
      document.getElementById('date').value = txn.date;
      document.getElementById('notes').value = txn.notes || '';
      openModal();
    }

    async function deleteTransaction(id) {
      if (!confirm('Delete this transaction?')) return;
      try {
        await deleteTransactionFromFirestore(id);
      } catch (err) {
        alert('Delete failed: ' + err.message);
      }
    }

    // Recurring
    async function handleRecurringSubmit(event) {
      event.preventDefault();
      if (!uid) return alert('Please log in to add recurring payments');

      const recurring = {
        title: document.getElementById('recurring-title').value,
        amount: parseFloat(document.getElementById('recurring-amount').value),
        category: document.getElementById('recurring-category').value,
        frequency: document.getElementById('recurring-frequency').value,
        dueDate: parseInt(document.getElementById('recurring-duedate').value),
        notify: document.getElementById('recurring-notify').checked
      };

      try {
        await addRecurringToFirestore(recurring);
        closeRecurringModal();
      } catch (err) {
        alert('Failed to add recurring payment: ' + err.message);
      }
    }

    function renderRecurringList() {
      const container = document.getElementById('recurring-list');
      if (!recurringPayments || recurringPayments.length === 0) container.innerHTML = '<div style="color:var(--muted);padding:12px;">No recurring payments</div>';
      else container.innerHTML = recurringPayments.map(r => `
        <div style="display:flex;justify-content:space-between;align-items:center;padding:10px;background:rgba(0,0,0,0.02);border-radius:8px;margin-bottom:8px;">
          <div>
            <div style="font-weight:700;color:var(--text)">${escapeHtml(r.title)}</div>
            <div style="font-size:13px;color:var(--muted)">${capitalize(r.frequency)} • Due: ${r.dueDate}th</div>
          </div>
          <div style="text-align:right">
            <div style="font-weight:800">${currency}${(r.amount||0).toLocaleString('en-IN')}</div>
            <div style="margin-top:6px;"><button class="action-btn" onclick="deleteRecurring('${r.id}')">🗑️</button></div>
          </div>
        </div>
      `).join('');
    }

    async function deleteRecurring(id) {
      if (!confirm('Delete this recurring payment?')) return;
      try { await deleteRecurringFromFirestore(id); } catch (err) { alert('Delete failed: ' + err.message); }
    }

    // ---------- Charts & Analytics ----------
    function updateAnalytics() {
      const now = new Date();
      const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
      const monthExpenses = transactions.filter(t => t.type === 'expense' && new Date(t.date) >= monthStart).reduce((sum,t)=>sum+parseFloat(t.amount||0),0);
      const weekAgo = new Date(now); weekAgo.setDate(weekAgo.getDate() - 7);
      const weekExpenses = transactions.filter(t => t.type === 'expense' && new Date(t.date) >= weekAgo).reduce((sum,t)=>sum+parseFloat(t.amount||0),0);
      const totalExpenses = transactions.filter(t => t.type === 'expense').reduce((sum,t)=>sum+parseFloat(t.amount||0),0);
      const daysWithExpenses = new Set(transactions.filter(t => t.type === 'expense').map(t=>t.date)).size;
      const avgDaily = daysWithExpenses > 0 ? totalExpenses / daysWithExpenses : 0;

      document.getElementById('stat-total').textContent = transactions.length;
      document.getElementById('stat-avg').textContent = currency + avgDaily.toLocaleString('en-IN', {maximumFractionDigits:2});
      document.getElementById('stat-month').textContent = currency + monthExpenses.toLocaleString('en-IN', {maximumFractionDigits:2});
      document.getElementById('stat-week').textContent = currency + weekExpenses.toLocaleString('en-IN', {maximumFractionDigits:2});

      renderPieChart();
      renderLineChart();
    }

    function renderPieChart() {
      const categoryTotals = {};
      transactions.forEach(txn => {
        if (txn.type === 'expense') {
          const amount = parseFloat(txn.amount || 0);
          categoryTotals[txn.category] = (categoryTotals[txn.category] || 0) + amount;
        }
      });
      const categoryArray = Object.entries(categoryTotals).sort((a,b)=> b[1]-a[1]);
      const colors = ['#ff6b35', '#f7931e', '#fdc500', '#c7d301', '#4caf50', '#00bcd4', '#2196f3', '#3f51b5', '#9c27b0'];

      const ctx = document.getElementById('pie-chart').getContext('2d');
      if (pieChartInstance) pieChartInstance.destroy();
      pieChartInstance = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: categoryArray.map(c=>c[0]),
          datasets: [{ data: categoryArray.map(c=>c[1]), backgroundColor: colors.slice(0,categoryArray.length), borderRadius:8, borderWidth:2, borderColor: (document.body.classList.contains('dark') ? '#0f1720' : '#fff') }]
        },
        options: { responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'bottom', labels:{ font:{ size:13 }, color: (document.body.classList.contains('dark') ? '#cbd5e1' : '#666')} } } }
      });
    }

    function renderLineChart() {
      const monthData = {};
      for (let i = 11; i >= 0; i--) {
        const date = new Date();
        date.setMonth(date.getMonth() - i);
        const monthKey = date.toLocaleDateString('en-IN',{month:'short', year:'2-digit'});
        const monthStart = new Date(date.getFullYear(), date.getMonth(), 1);
        const monthEnd = new Date(date.getFullYear(), date.getMonth() + 1, 0);
        const monthExpense = transactions.filter(t => t.type === 'expense' && new Date(t.date) >= monthStart && new Date(t.date) <= monthEnd).reduce((s,t)=>s+parseFloat(t.amount||0),0);
        monthData[monthKey] = monthExpense;
      }
      const ctx = document.getElementById('line-chart').getContext('2d');
      if (lineChartInstance) lineChartInstance.destroy();
      lineChartInstance = new Chart(ctx, {
        type:'line',
        data: {
          labels: Object.keys(monthData),
          datasets: [{
            label: 'Monthly Expense',
            data: Object.values(monthData),
            borderColor: 'var(--brand)',
            backgroundColor: 'rgba(255,107,53,0.08)',
            borderWidth: 3, tension: 0.3, fill: true, pointRadius: 5,
            pointBackgroundColor: 'var(--brand)', pointBorderColor: (document.body.classList.contains('dark') ? '#0f1720' : '#fff'), pointBorderWidth: 2
          }]
        },
        options: { responsive:true, maintainAspectRatio:false, plugins:{ legend:{ labels:{ font:{ size:13 }, color: (document.body.classList.contains('dark') ? '#cbd5e1' : '#666') } } }, scales:{ y:{ beginAtZero:true, ticks:{ color: (document.body.classList.contains('dark') ? '#cbd5e1' : '#666') } }, x:{ ticks:{ color: (document.body.classList.contains('dark') ? '#cbd5e1' : '#666') } } } }
      });
    }

    // ---------- Filters & Navigation ----------
    function filterTransactions(type, ev) {
      currentFilter = type;
      const firstFilters = document.querySelectorAll('#page-history .filters')[0];
      if (firstFilters) firstFilters.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
      if (ev && ev.target) ev.target.classList.add('active');
      updateAllTransactions();
    }

    function filterByDate(period, ev) {
      currentDateFilter = period;
      const secondFilters = document.querySelectorAll('#page-history .filters')[1];
      if (secondFilters) secondFilters.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
      if (ev && ev.target) ev.target.classList.add('active');
      updateAllTransactions();
    }

    document.getElementById('search-box') && document.getElementById('search-box').addEventListener('input', updateAllTransactions);

    function showIncome() { switchPage('history'); currentFilter='income'; currentDateFilter='all'; document.querySelectorAll('#page-history .filters')[0].querySelectorAll('.filter-btn')[1]?.classList.add('active'); updateAllTransactions(); }
    function showExpense() { switchPage('history'); currentFilter='expense'; currentDateFilter='all'; document.querySelectorAll('#page-history .filters')[0].querySelectorAll('.filter-btn')[2]?.classList.add('active'); updateAllTransactions(); }
    function openBudgetPage() { switchPage('budget'); }

    // ---------- Budget & Category Budgets ----------
    async function setBudget() {
      const amount = parseFloat(document.getElementById('budget-amount').value);
      if (isNaN(amount) || amount <= 0) return alert('Enter a valid budget');
      monthlyBudget = amount;
      await writeSettingsToFirestore();
      document.getElementById('budget-amount').value = '';
      alert('Budget set successfully!');
    }

    async function setGoal() {
      const amount = parseFloat(document.getElementById('goal-amount').value);
      if (isNaN(amount) || amount <= 0) return alert('Enter a valid goal amount');
      savingsGoal = amount;
      await writeSettingsToFirestore();
      document.getElementById('goal-amount').value = '';
      alert('Goal set successfully!');
    }

    function renderCategoryBudgets() {
      const container = document.getElementById('category-budget-list');
      container.innerHTML = categories.map(cat => `
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
          <span style="width:120px;display:inline-block;font-weight:600;">${escapeHtml(cat.name)}</span>
          <input type="number" class="form-input" id="cat-budget-${escapeId(cat.name)}" value="${categoryBudgets[cat.name]||''}" placeholder="₹0" min="0" style="flex:1;">
        </div>
      `).join('') || '<div style="color:var(--muted);padding:8px">No categories</div>';
    }

    async function saveCategoryBudgets() {
      categories.forEach(cat => {
        const el = document.getElementById(`cat-budget-${escapeId(cat.name)}`);
        categoryBudgets[cat.name] = el ? (parseFloat(el.value) || 0) : (categoryBudgets[cat.name] || 0);
      });
      await writeSettingsToFirestore();
      updateBudgetHome();
      generateNotifications();
      alert('Category budgets saved!');
    }

    function escapeId(s) { return s.replace(/[^a-z0-9]/gi,'_'); }

    // ---------- Category Dropdown (dynamic by tx type) ----------
    function updateCategoryDropdown() {
      // attach type change listener to update categories when user switches type
      const typeSelect = document.getElementById('type');
      if (typeSelect) {
        typeSelect.removeEventListener('change', onTypeChangeForCategories);
        typeSelect.addEventListener('change', onTypeChangeForCategories);
      }
      populateCategoryOptions(typeSelect ? typeSelect.value : 'expense');
    }

    function onTypeChangeForCategories(e) {
      populateCategoryOptions(e.target.value);
    }

    function populateCategoryOptions(type) {
      // type = 'income' or 'expense'
      const selects = document.querySelectorAll('#category, #recurring-category');
      selects.forEach(select => {
        // recurring-category - we prefer expense categories, but allow both/income as per type param
        const options = categories
          .filter(c => c.type === 'both' || c.type === type)
          .map(c => `<option value="${escapeHtmlAttr(c.name)}">${escapeHtml(c.name)}</option>`)
          .join('');
        // if none found, show all categories as fallback
        select.innerHTML = options || categories.map(c => `<option value="${escapeHtmlAttr(c.name)}">${escapeHtml(c.name)}</option>`).join('');
      });
    }

    async function changeCurrency() {
      currency = document.getElementById('currency-select').value;
      await writeSettingsToFirestore();
      updateUI();
    }

    // ---------- Modal Controls ----------
    function openModal() {
      if (!uid) return alert('Please log in to add transactions');
      document.getElementById('modal-title').textContent = 'Add Transaction';
      document.getElementById('modal-overlay').classList.add('show');
      document.getElementById('date').valueAsDate = new Date();
      editingIndex = -1;
      // default populate categories for default type value
      populateCategoryOptions(document.getElementById('type').value);
    }

    function closeModal() {
      document.getElementById('modal-overlay').classList.remove('show');
      document.getElementById('transaction-form').reset();
      editingIndex = -1;
    }

    function closeModalOnOverlay(event) { if (event.target.id === 'modal-overlay') closeModal(); }

    function openRecurringModal() {
      if (!uid) return alert('Please log in to add recurring payments');
      document.getElementById('recurring-modal').classList.add('show');
      // recurring default categories: expense + both
      const recSelect = document.getElementById('recurring-category');
      recSelect && (recSelect.innerHTML = categories.filter(c=>c.type==='expense'||c.type==='both').map(c=>`<option value="${escapeHtmlAttr(c.name)}">${escapeHtml(c.name)}</option>`).join(''));
    }

    function closeRecurringModal(event) {
      if (!event || event.target.id === 'recurring-modal') {
        document.getElementById('recurring-modal').classList.remove('show');
        document.getElementById('recurring-form').reset();
      }
    }

    // ---------- Navigation ----------
    function switchPage(page) {
      document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
      const navItems = document.querySelectorAll('.nav-item');
      const pages = ['home','history','analytics','recurring','budget','settings'];
      const idx = pages.indexOf(page);
      if (idx >= 0 && navItems[idx]) navItems[idx].classList.add('active');
      document.querySelectorAll('.page-section').forEach(s => s.classList.remove('active'));
      const el = document.getElementById('page-' + page);
      if (el) el.classList.add('active');
      closeSidebar();
      document.getElementById('notification-panel').classList.remove('show');
      if (page === 'analytics') setTimeout(() => updateAnalytics(), 120);
      if (page === 'settings') { renderCategoriesList(); } // refresh categories view
    }

    function openSidebar() { document.getElementById('sidebar').classList.add('open'); document.getElementById('sidebar-overlay').classList.add('show'); document.body.style.overflow = 'hidden'; }
    function closeSidebar() { document.getElementById('sidebar').classList.remove('open'); document.getElementById('sidebar-overlay').classList.remove('show'); document.body.style.overflow = ''; }
    function toggleNotifications() { document.getElementById('notification-panel').classList.toggle('show'); }

    // ---------- Notifications ----------
    function generateNotifications() {
      notifications = [];
      const now = new Date();
      const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
      const monthExpenses = transactions.filter(t => t.type === 'expense' && new Date(t.date) >= monthStart).reduce((s,t)=>s+parseFloat(t.amount||0),0);
      if (monthlyBudget > 0) {
        const percent = (monthExpenses / monthlyBudget * 100);
        if (percent > 90) notifications.push({ type: 'warning', title: '⚠️ Budget Alert', message: `You've spent ${percent.toFixed(0)}% of your monthly budget` });
      }
      const categoryTotals = {};
      transactions.forEach(t => {
        if (t.type === 'expense' && new Date(t.date) >= monthStart) categoryTotals[t.category] = (categoryTotals[t.category] || 0) + parseFloat(t.amount || 0);
      });
      Object.entries(categoryTotals).forEach(([cat, spent]) => {
        const budget = categoryBudgets[cat] || 0;
        if (budget > 0 && spent > budget) notifications.push({ type: 'warning', title: `💸 ${cat} Budget Exceeded`, message: `Spent ${currency}${spent.toLocaleString('en-IN')} of ${currency}${budget.toLocaleString('en-IN')}` });
      });
      recurringPayments.forEach(r => {
        const nextDue = new Date(now.getFullYear(), now.getMonth(), r.dueDate || 1);
        const daysUntil = Math.ceil((nextDue - now) / (1000*60*60*24));
        if (daysUntil >= 0 && daysUntil <= 3 && r.notify) notifications.push({ type: 'info', title: `📅 ${r.title} Due Soon`, message: `Due in ${daysUntil} days - ${currency}${(r.amount||0).toLocaleString('en-IN')}` });
      });
      updateNotificationPanel();
    }

    function updateNotificationPanel() {
      const container = document.getElementById('notifications-list');
      const dot = document.getElementById('notification-dot');
      if (notifications.length > 0) {
        dot.classList.add('show');
        container.innerHTML = notifications.map(n => `
          <div class="notification-item ${n.type}">
            <div class="notification-title">${escapeHtml(n.title)}</div>
            <div class="notification-message">${escapeHtml(n.message)}</div>
          </div>
        `).join('');
      } else {
        dot.classList.remove('show');
        container.innerHTML = '<div style="padding:16px;text-align:center;color:var(--muted);">No notifications</div>';
      }
    }

    // ---------- Export / Import ----------
    function exportCSV() {
      const csvRows = [['Date','Type','Title','Category','Amount','Notes'].join(',')];
      transactions.forEach(t => {
        csvRows.push([t.date, t.type, `"${(t.title||'').replace(/"/g,'""')}"`, `"${(t.category||'').replace(/"/g,'""')}"`, t.amount, `"${(t.notes||'').replace(/"/g,'""')}"`].join(','));
      });
      const csv = csvRows.join('\n');
      downloadFile(csv, 'trackit-transactions.csv', 'text/csv');
    }

    function exportJSON() {
      const data = JSON.stringify({ transactions, recurringPayments, categories, monthlyBudget, categoryBudgets, savingsGoal, currency, theme }, null, 2);
      downloadFile(data, 'trackit-backup.json', 'application/json');
    }

    function downloadFile(content, filename, type) {
      const blob = new Blob([content], { type });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = filename; a.click(); URL.revokeObjectURL(url);
    }

    function importData() { document.getElementById('import-file').click(); }

    async function handleImport(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = async function(e) {
        try {
          const data = JSON.parse(e.target.result);
          if (!uid) return alert('Please log in to import data to your account');
          if (!confirm('Replace all data in your account? This will delete existing transactions & recurring items.')) return;
          // Note: clearing collections on Firestore would require batched deletes; for brevity, we keep logic minimal here
          // We'll write settings and upload transactions & recurring as new docs
          const txCol = collection(db, 'users', uid, 'transactions');
          for (const t of (data.transactions || [])) await addDoc(txCol, t);
          const recCol = collection(db, 'users', uid, 'recurring');
          for (const r of (data.recurringPayments || [])) await addDoc(recCol, r);
          // categories might be array of strings or objects
          categories = normalizeIncomingCategories(data.categories || categories);
          monthlyBudget = data.monthlyBudget || 0;
          categoryBudgets = data.categoryBudgets || {};
          savingsGoal = data.savingsGoal || 0;
          currency = data.currency || currency;
          theme = data.theme || theme;
          await writeSettingsToFirestore();
          alert('Data imported!');
        } catch (err) { alert('Invalid file or import failed: ' + err.message); }
      };
      reader.readAsText(file);
      event.target.value = '';
    }

    // ---------- Settings: Add / Remove categories ----------
    function renderCategoriesList() {
      const container = document.getElementById('categories-list');
      if (!container) return;
      container.innerHTML = categories.map((c, idx) => `
        <div style="display:flex;align-items:center;justify-content:space-between;padding:8px;border-radius:8px;background:rgba(0,0,0,0.02);">
          <div style="display:flex;align-items:center;gap:10px;">
            <div style="width:36px;height:36px;border-radius:8px;background:rgba(0,0,0,0.04);display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--muted);">${(c.name||'')[0]||''}</div>
            <div>
              <div style="font-weight:700;color:var(--text)">${escapeHtml(c.name)}</div>
              <div style="font-size:13px;color:var(--muted)">${capitalize(c.type)}</div>
            </div>
          </div>
          <div style="display:flex;gap:8px;align-items:center;">
            <button class="btn btn-secondary" onclick="toggleCategoryType(${idx})" title="Toggle type">↔️</button>
            <button class="btn btn-secondary" style="background:#ef4444;color:#fff;" onclick="removeCategory(${idx})">Delete</button>
          </div>
        </div>
      `).join('') || '<div style="color:var(--muted);padding:8px">No categories yet</div>';
    }

    async function addCategory() {
      const nameEl = document.getElementById('new-category-name');
      const typeEl = document.getElementById('new-category-type');
      const name = (nameEl.value || '').trim();
      const type = typeEl.value || 'expense';
      if (!name) return alert('Enter category name');
      // prevent duplicates (case-insensitive)
      if (categories.some(c => c.name.toLowerCase() === name.toLowerCase())) return alert('Category already exists');
      categories.push({ name, type });
      await writeSettingsToFirestore();
      nameEl.value = '';
      renderCategoriesList();
      updateCategoryDropdown();
      renderCategoryBudgets();
      alert('Category added');
    }

    async function removeCategory(idx) {
      if (!confirm('Delete this category? Existing transactions with this category will remain unchanged.')) return;
      categories.splice(idx,1);
      await writeSettingsToFirestore();
      renderCategoriesList();
      updateCategoryDropdown();
      renderCategoryBudgets();
    }

    // toggle category type between expense/income/both
    async function toggleCategoryType(idx) {
      const c = categories[idx];
      if (!c) return;
      if (c.type === 'expense') c.type = 'income';
      else if (c.type === 'income') c.type = 'both';
      else c.type = 'expense';
      await writeSettingsToFirestore();
      renderCategoriesList();
      updateCategoryDropdown();
    }

    // ---------- Modals / helpers ----------
    function escapeHtml(str){ if(!str && str!==0) return ''; return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s])); }
    function escapeHtmlAttr(s){ return escapeHtml(s).replace(/"/g,'&quot;'); }
    function capitalize(s){ return (s||'').charAt(0).toUpperCase() + (s||'').slice(1); }

    // ---------- Notifications & budgets (already defined above) ----------

    // ---------- Theme (Dark mode) ----------
    document.getElementById('dark-mode-toggle').addEventListener('change', async (e) => {
      theme = e.target.checked ? 'dark' : 'light';
      applyTheme();
      await writeSettingsToFirestore();
    });

    function applyTheme() {
      if (theme === 'dark') document.body.classList.add('dark');
      else document.body.classList.remove('dark');
      // update chart colors if they exist
      try { if (pieChartInstance) pieChartInstance.destroy(); if (lineChartInstance) lineChartInstance.destroy(); updateAnalytics(); } catch(e){}
      document.getElementById('dark-mode-toggle').checked = (theme === 'dark');
    }

    // ---------- Notifications generation already present ----------

    // ---------- Utilities: normalize categories from older format ----------
    function normalizeIncomingCategories(incoming) {
      // incoming may be array of strings OR array of objects
      if (!Array.isArray(incoming)) return categories;
      if (incoming.length === 0) return categories;
      if (typeof incoming[0] === 'object' && incoming[0].name) return incoming;
      // else it's array of strings -> map some common incomes to income type, rest expense
      const knownIncome = ['salary','income','interest','refund','bonus'];
      return incoming.map(name => {
        const lower = (name || '').toLowerCase();
        const type = knownIncome.includes(lower) ? 'income' : (lower === 'other' ? 'both' : 'expense');
        return { name, type };
      });
    }

    function normalizeCategories(){
      // ensure categories array has objects with name & type
      categories = (categories || []).map(c => {
        if (typeof c === 'string') {
          const lower = c.toLowerCase();
          const knownIncome = ['salary','income','interest','refund','bonus'];
          return { name: c, type: knownIncome.includes(lower) ? 'income' : (lower === 'other' ? 'both' : 'expense') };
        }
        return { name: c.name || 'Unnamed', type: (c.type || 'expense') };
      });
      // dedupe by name (case-insensitive)
      const map = {};
      categories.forEach(c => { map[c.name.toLowerCase()] = { name: c.name, type: c.type }; });
      categories = Object.values(map);
    }

    // ---------- Modal open/close and category population listeners ----------
    document.getElementById('type').addEventListener('change', (e) => populateCategoryOptions(e.target.value));

    // ---------- Start/stop & misc ----------
    function openSidebarIfSmall(){ if(window.innerWidth <= 900) openSidebar(); }
    window.addEventListener('resize', () => { if(window.innerWidth > 900) closeSidebar(); });

    // ---------- Notifications generation uses functions defined earlier ----------

    // ---------- Misc helpers ----------
    function escapeId(s) { return (s||'').replace(/[^a-z0-9]/gi,'_'); }

    // ---------- Add a small safety catch for missing elements ----------
    function safeGet(id){ return document.getElementById(id) || { value:'', addEventListener(){}, innerHTML:'' }; }

    // ---------- Simple clear data (danger zone) ----------
    async function resetData() {
      if (!uid) return alert('Please log in to reset');
      if (!confirm('Delete all your transactions, recurring items, and reset settings?')) return;
      // For safety we only reset the settings doc here; deleting collections properly needs batched deletes.
      await setDoc(doc(db, 'users', uid, 'settings', 'prefs'), {
        categories,
        monthlyBudget: 0,
        categoryBudgets: {},
        savingsGoal: 0,
        currency,
        theme: 'light'
      }, { merge: true });
      // Note: Transactions & recurring items will still remain unless you explicitly delete them via console or add batch delete logic.
      alert('Settings reset. To delete transactions/recurring items, please remove them manually.');
    }

    // ---------- Simple helpers used earlier ----------
    function escapeHtml(str){ if(!str && str!==0) return ''; return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s])); }

    // ---------- Initialization steps for categories & UI updated again ----------
    normalizeCategories();
    updateCategoryDropdown();
    renderCategoriesList();
    renderCategoryBudgets();

    // Expose some functions to global for inline onclick handlers
    window.openModal = openModal;
    window.closeModal = closeModal;
    window.closeModalOnOverlay = closeModalOnOverlay;
    window.openRecurringModal = openRecurringModal;
    window.closeRecurringModal = closeRecurringModal;
    window.handleSubmit = handleSubmit;
    window.editTransaction = editTransaction;
    window.deleteTransaction = deleteTransaction;
    window.filterTransactions = filterTransactions;
    window.filterByDate = filterByDate;
    window.showIncome = showIncome;
    window.showExpense = showExpense;
    window.openBudgetPage = openBudgetPage;
    window.setBudget = setBudget;
    window.setGoal = setGoal;
    window.saveCategoryBudgets = saveCategoryBudgets;
    window.addCategory = addCategory;
    window.removeCategory = removeCategory;
    window.toggleCategoryType = toggleCategoryType;
    window.exportCSV = exportCSV;
    window.exportJSON = exportJSON;
    window.importData = importData;
    window.handleImport = handleImport;
    window.resetData = resetData;
    window.openSidebar = openSidebar;
    window.closeSidebar = closeSidebar;
    window.toggleNotifications = toggleNotifications;
    window.deleteRecurring = deleteRecurring;
    window.handleRecurringSubmit = handleRecurringSubmit;

  </script>
</body>
</html>
